{{- if .Values.externalSecrets.enabled -}}
# ExternalSecret pulls secrets from Vault and creates a K8s Secret
# Uses the existing ClusterSecretStore (vault-backend) created by investify
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "fleet.fullname" . }}-external-secret
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "fleet.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  
  target:
    name: app-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # MongoDB
        mongodb-uri: "{{ `{{ .MONGODB_URI }}` }}"
        
        # JWT
        jwt-secret: "{{ `{{ .JWT_SECRET }}` }}"
        
        # CORS
        allowed-origins: "{{ `{{ .ALLOWED_ORIGINS }}` }}"
        
        # SMTP Configuration
        smtp-host: "{{ `{{ .SMTP_HOST }}` }}"
        smtp-port: "{{ `{{ .SMTP_PORT | default \"587\" }}` }}"
        smtp-username: "{{ `{{ .SMTP_USERNAME }}` }}"
        smtp-password: "{{ `{{ .SMTP_PASSWORD }}` }}"
        smtp-from-email: "{{ `{{ .SMTP_FROM_EMAIL }}` }}"
        smtp-from-name: "{{ `{{ .SMTP_FROM_NAME }}` }}"
        
        # App URL
        app-url: "{{ `{{ .APP_URL }}` }}"
  
  # Data to fetch from Vault
  # Path format: secret/data/fleet/<environment>
  data:
    - secretKey: MONGODB_URI
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: MONGODB_URI
    - secretKey: JWT_SECRET
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: JWT_SECRET
    - secretKey: ALLOWED_ORIGINS
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: ALLOWED_ORIGINS
    - secretKey: SMTP_HOST
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: SMTP_HOST
    - secretKey: SMTP_PORT
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: SMTP_PORT
    - secretKey: SMTP_USERNAME
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: SMTP_USERNAME
    - secretKey: SMTP_PASSWORD
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: SMTP_PASSWORD
    - secretKey: SMTP_FROM_EMAIL
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: SMTP_FROM_EMAIL
    - secretKey: SMTP_FROM_NAME
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: SMTP_FROM_NAME
    - secretKey: APP_URL
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath }}
        property: APP_URL
{{- end }}
